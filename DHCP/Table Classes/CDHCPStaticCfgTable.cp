// =================================================================================//	CDHCPStaticCfgTable.cp				©1999 Sustainable Softworks All rights reserved.// =================================================================================//	Table object to display DHCP Status information#include "CDHCPStaticCfgTable.h"#include "CWindow.h"#include <PP_Messages.h>#include "AGAColors.h"#include "IPSupport.h"#include "MacSupport.h"//#include "CIPNumberEditField.h"#include <LString.h>// Globalsextern CDHCPData* gDHCPData;// ---------------------------------------------------------------------------------//		¥ CDHCPStaticCfgTable(LStream*)// ---------------------------------------------------------------------------------CDHCPStaticCfgTable::CDHCPStaticCfgTable(	LStream	*inStream )		: CEditTable( inStream ){}// ---------------------------------------------------------------------------------//		¥ ~CDHCPStaticCfgTable// ---------------------------------------------------------------------------------CDHCPStaticCfgTable::~CDHCPStaticCfgTable(){}// ---------------------------------------------------------------------------------//		¥ FinishCreateSelf// ---------------------------------------------------------------------------------//	Finish creating the DHCP table.voidCDHCPStaticCfgTable::FinishCreateSelf(){	// set column types	SetColType(kColTypeIPAddr, 1, 1);		// network interface	SetColType(kColTypeIPAddr, 2, 2);		// lease address	SetColType(kColTypeHWAddr, 3, 3);		// hardware address	SetColType(kColTypeComment1, 4, 4);		// client ID	SetColWidth(kColWidthIPAddr, 1, 2);	SetColWidth(kColWidthHWAddr, 3, 3);	SetColWidth(500, 4, 4);	// get edit in place field	mEditField = (LEditField*)FindPaneByID( kTableEditField );}// ---------------------------------------------------------------------------------//		¥ GetDHCPStaticCfgEntry// ---------------------------------------------------------------------------------//	Get DHCPStaticCfg Entry from TableBooleanCDHCPStaticCfgTable::GetDHCPStaticCfgEntry(TableIndexT inRow, DHCPStaticCfgEntry_t* outEntry){	TableCellT		theCell;	TableItemW		tData;	Str255			str;	Boolean			result = true;		do {		// check for valid row entry (has an interface address)		theCell.row = inRow;		theCell.col = kColDHCPStaticCfgInterfaceAddr;				if (!IsValidCell(theCell)) {			result = false;			break;		}		GetCellData(theCell, &tData);		if (tData.hi == 0) {			result = false;			break;		}		// initialize output buffer		bzero((UInt8*)outEntry, sizeof(DHCPStaticCfgEntry_t));		// get entry			// Network Interface		theCell.col = kColDHCPStaticCfgInterfaceAddr;		GetCellData(theCell, &tData);			// Network Interface		outEntry->interfaceAddr = tData.hi;			// IP Addr		theCell.col = kColDHCPStaticCfgIPAddr;				GetCellData(theCell, &tData);		outEntry->leaseAddr = tData.hi;			// IP Addr			// HW Addr		theCell.col = kColDHCPStaticCfgHWAddr;		GetCellData(theCell, &tData);			// HW Addr		outEntry->hardwareAddr = *(MACAddr_t*)&tData;			// Client ID		GetCommentData(theCell.row, 1, str);		DecodeHexStr(str, outEntry->clientID);		outEntry->isDone = true;				// is done	} while (false);		return result;}// ---------------------------------------------------------------------------------//		¥ SetDHCPStaticCfgEntry// ---------------------------------------------------------------------------------//	Set DHCPStaticCfg Entry in Table//	Refresh if entry was changedvoidCDHCPStaticCfgTable::SetDHCPStaticCfgEntry(TableIndexT inRow, DHCPStaticCfgEntry_t* inEntry){	TableCellT		theCell;	TableItemW		tData, uData;	Str255			str;	Str255			tStr;	Boolean			result = false;	do {		// check for valid row entry		if (inRow > kMaxDHCPStaticCfgTableRows) {			result = false;			break;		}		// insert rows if needed		if (inRow > mRows) {			tData.hi = 0;			tData.lo = 0;			InsertRows(inRow-mRows, mRows, &tData);	// how many, after row, *data		}		// set entry		theCell.row = inRow;			// interfaceAddr		theCell.col = kColDHCPStaticCfgInterfaceAddr;		tData.hi = inEntry->interfaceAddr;		tData.lo = 0;		GetCellData(theCell, &uData);		if (tData.hi != uData.hi) {			SetCellData(theCell, &tData);			result = true;		}			// leaseAddr		theCell.col = kColDHCPStaticCfgIPAddr;		tData.hi = inEntry->leaseAddr;		tData.lo = 0;		GetCellData(theCell, &uData);		if (tData.hi != uData.hi) {			SetCellData(theCell, &tData);			result = true;		}			// hardwareAddr		theCell.col = kColDHCPStaticCfgHWAddr;		tData.hi = inEntry->hardwareAddr.first4;		tData.lo = inEntry->hardwareAddr.last2 << 16;		GetCellData(theCell, &uData);		if ((tData.hi != uData.hi) || (tData.lo != uData.lo)) {			SetCellData(theCell, &tData);			result = true;		}			// ClientID		theCell.col = kColDHCPStaticCfgClientID;		GetCommentData(inRow, 1, str);		EncodeHexStr(inEntry->clientID, tStr);		if (!EqualString(str, tStr, false, false)) {			SetCommentData(inRow, 1, tStr);			tData.hi = kCommentFlag;			tData.lo = 0;			SetCellData(theCell, &tData);			result = true;		}	} while (false);	if (result) RefreshRow(inRow);}// ---------------------------------------------------------------------------------//		¥ UpdateTable// ---------------------------------------------------------------------------------//	Update DHCP Status Table from data objectvoidCDHCPStaticCfgTable::UpdateTable(){	ArrayIndexT			num;	ArrayIndexT			index;	ArrayIndexT			last;	DHCPStaticCfgEntry_t	entry;		num = gDHCPData->GetDataCountDHCPStaticCfg();	last = FindLastRow();	if (last > num) num = last;	for (index=1; index<=num; index++) {		if (gDHCPData->GetDataDHCPStaticCfgArray(index, &entry)) {			SetDHCPStaticCfgEntry(index, &entry);		} else {			ClearRow(index);		}	}	// inherit behavior	CEditTable::UpdateTable();}// ---------------------------------------------------------------------------------//		¥ UpdateData// ---------------------------------------------------------------------------------//	Update data object from TablevoidCDHCPStaticCfgTable::UpdateData(){	ArrayIndexT			num;	ArrayIndexT			index;	ArrayIndexT			skip;	DHCPStaticCfgEntry_t	entry;	// inherit behavior	CEditTable::UpdateData();		//num = gDHCPData->GetDataCountDHCPDynamicCfg();	num = FindLastRow();	skip = 0;	for (index=1; index<=num; index++) {		if (GetDHCPStaticCfgEntry(index, &entry)) {			gDHCPData->SetDataDHCPStaticCfgArray(index, &entry);		} else skip += 1;	}	gDHCPData->SetDataCountDHCPStaticCfg(num-skip);		// restore target	CEditTable::ShowSelf();}// ---------------------------------------------------------------------------//		¥ Draw Cell// ---------------------------------------------------------------------------voidCDHCPStaticCfgTable::DrawCell(	const TableCellT	&inCell){	Rect		cellFrame;	wide		tData;	OSErr		err = 0;	if (FetchLocalContentFrame(inCell, cellFrame)) {		// draw white background		::PenNormal();		ApplyForeAndBackColors();		::EraseRect(&cellFrame);		// draw border around cell		::InsetRect(&cellFrame, -1, -1);		::PenPat(&UQDGlobals::GetQDGlobals()->gray);		if (PaneInColor (this)) {			StColorState	saveColor;			RGBColor		emptyColor;			emptyColor = gAGAColorArray[6];			::RGBForeColor(&emptyColor);			::FrameRect(&cellFrame);		} else { ::FrameRect(&cellFrame); }		::PenPat(&UQDGlobals::GetQDGlobals()->black);				// draw contents		::TextFont(applFont);		::TextFace(0);	// normal		::TextSize(9);		// Get cell data		GetCellData( inCell, &tData );		// Handle our unique columns		// inherit behavior for common data types		CConfigureTable::DrawCell(inCell);	}}